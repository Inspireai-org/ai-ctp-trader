# CTP期货交易接入需求文档

## 简介

本文档定义了InspirAI Trader系统接入CTP（Comprehensive Transaction Platform）期货交易平台的完整需求。系统需要实现期货市场数据的实时接收、交易指令的发送执行、账户持仓管理等核心功能，支持广州期货评测环境和生产环境的切换。

## 需求列表

### 需求1：CTP连接管理

**用户故事：** 作为交易员，我希望系统能够稳定连接到CTP交易平台，以便进行期货交易操作。

#### 验收标准

1. 当系统启动时，系统应当自动加载正确的CTP动态库文件（macOS: cepin框架）
2. 当用户选择交易环境时，系统应当提供广州期货评测环境和SimNow测试环境选项
3. 当连接断开时，系统应当自动重连并恢复之前的订阅状态
4. 如果连接失败，系统应当显示详细的错误信息和解决建议
5. 当切换环境时，系统应当正确保存和加载对应的配置参数

### 需求2：用户认证与登录

**用户故事：** 作为交易员，我希望能够安全地登录到CTP系统，以便访问我的交易账户。

#### 验收标准

1. 当用户登录交易系统时，系统应当使用正确的认证码（QHFK5E2GLEUB9XHV）进行认证
2. 当认证成功后，系统应当使用用户提供的账号密码进行登录
3. 如果登录失败，系统应当显示具体的失败原因
4. 当登录成功时，系统应当获取并保存会话信息（FrontID、SessionID）
5. 当用户退出时，系统应当正确释放所有资源并断开连接

### 需求3：行情数据接收

**用户故事：** 作为交易员，我希望实时接收期货行情数据，以便做出交易决策。

#### 验收标准

1. 当用户订阅合约时，系统应当立即发送订阅请求到CTP服务器
2. 当收到行情数据时，系统应当在100毫秒内更新前端界面
3. 如果行情数据包含异常值，系统应当过滤并记录日志
4. 当用户取消订阅时，系统应当停止接收该合约的行情数据
5. 当市场闭市时，系统应当显示最后的收盘价格

### 需求4：订单管理

**用户故事：** 作为交易员，我希望能够下单、撤单和查询订单状态，以便执行交易策略。

#### 验收标准

1. 当用户提交订单时，系统应当验证订单参数的合法性
2. 当订单被接受时，系统应当实时更新订单状态
3. 如果订单被拒绝，系统应当显示拒绝原因和建议
4. 当用户撤单时，系统应当立即发送撤单请求
5. 当收到成交回报时，系统应当更新持仓和资金信息

### 需求5：持仓与资金查询

**用户故事：** 作为交易员，我希望实时查看账户持仓和资金状况，以便管理风险。

#### 验收标准

1. 当用户登录成功时，系统应当自动查询当前持仓和资金
2. 当发生成交时，系统应当实时更新持仓数量和占用保证金
3. 如果查询失败，系统应当提供重试机制
4. 当日结算后，系统应当更新结算价和浮动盈亏
5. 当用户请求时，系统应当能够导出持仓报表

### 需求6：风险控制

**用户故事：** 作为交易员，我希望系统提供风险控制功能，以便避免超出风险限制。

#### 验收标准

1. 当下单前，系统应当检查是否超出持仓限制
2. 如果订单会导致保证金不足，系统应当拒绝该订单
3. 当账户风险度超过80%时，系统应当发出警告
4. 当达到涨跌停价格时，系统应当提示用户
5. 如果检测到异常交易行为，系统应当记录并报警

### 需求7：结算单确认

**用户故事：** 作为交易员，我需要确认每日结算单，以便继续交易。

#### 验收标准

1. 当用户首次登录时，系统应当提示确认结算单
2. 如果未确认结算单，系统应当禁止交易操作
3. 当确认结算单后，系统应当记录确认时间
4. 如果结算单查询失败，系统应当提供手动确认选项
5. 当日终结算完成后，系统应当自动获取最新结算单

### 需求8：开发测试支持

**用户故事：** 作为开发者，我希望有完善的测试和调试工具，以便快速定位和解决问题。

#### 验收标准

1. 当开发模式启动时，系统应当输出详细的调试日志
2. 当API调用失败时，系统应当记录完整的错误堆栈
3. 如果遇到编码问题，系统应当正确处理GB18030到UTF-8的转换
4. 当运行测试时，系统应当支持模拟环境和真实环境切换
5. 当调试下单流程时，系统应当提供单步执行和状态检查功能

### 需求9：前端界面集成

**用户故事：** 作为交易员，我希望有直观的图形界面展示行情和交易信息，以便快速操作。

#### 验收标准

1. 当行情更新时，界面应当实时刷新K线图和深度行情
2. 当下单时，界面应当提供快捷下单面板
3. 如果WebSocket连接断开，界面应当显示重连状态
4. 当切换合约时，界面应当立即加载该合约的历史数据
5. 当有新的成交时，界面应当弹出通知提醒

### 需求10：配置管理

**用户故事：** 作为系统管理员，我希望灵活配置交易参数，以便适应不同的交易环境。

#### 验收标准

1. 当切换环境时，系统应当自动加载对应的配置文件
2. 如果配置文件缺失，系统应当使用默认配置并提示
3. 当修改配置时，系统应当验证参数的合法性
4. 如果配置冲突，系统应当提示并拒绝启动
5. 当保存配置时，系统应当加密敏感信息（如密码）